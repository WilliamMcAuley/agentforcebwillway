{% extends "base.html" %}

{% block content %}
  <div class="container">
    <h1>Database Page</h1>
    <h3>List of Accounts</h3>
    <table class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Industry</th>
        </tr>
      </thead>
      <tbody>
        {% for account in accounts %}
          <tr>
            <td>{{ account.id }}</td>
            <td>
              <a href="{% url 'account_detail' account.id %}">{{ account.name }}</a>
            </td>
            <td>{{ account.industry }}</td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="3">No accounts found.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <h3>Accounts by Industry</h3>
    <canvas id="industryBubbleChart" width="600" height="300"></canvas>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      try {
        const industryData = {{ industry_counts|safe }};
        console.debug("Industry counts data:", industryData);

        if (industryData.length === 0) {
          document.getElementById('industryBubbleChart').outerHTML =
            "<div style='color: #888; margin: 1em 0;'>No industry data available to display chart.</div>";
        } else {
          const data = {
            datasets: industryData.map((item, idx) => ({
              label: item.industry || "Unknown",
              data: [{x: idx + 1, y: item.account_count, r: Math.max(10, item.account_count * 3)}],
              backgroundColor: `hsl(${idx * 40 % 360}, 70%, 60%)`
            }))
          };

          new Chart(document.getElementById('industryBubbleChart').getContext('2d'), {
            type: 'bubble',
            data: data,
            options: {
              plugins: {
                legend: { display: false }
              },
              scales: {
                x: {
                  title: { display: true, text: 'Industry' },
                  ticks: {
                    callback: function(value, index) {
                      return industryData[index] ? industryData[index].industry : '';
                    }
                  }
                },
                y: {
                  beginAtZero: true,
                  title: { display: true, text: 'Accounts' }
                }
              }
            });
        }
      } catch (err) {
        console.error("Error rendering industry bubble chart:", err);
        const chartContainer = document.getElementById('industryBubbleChart');
        if (chartContainer) {
          chartContainer.outerHTML = "<div style='color:red;'>Could not render chart. See console for details.</div>";
        }
      }
    </script>
    <pre>
      {{ industry_counts|safe }}
    </pre>
  </div>
{% endblock %}

