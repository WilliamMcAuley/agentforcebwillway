{% extends "base.html" %}

{% block content %}
  <div class="container">
    <h1>Database Page</h1>

    <h3>Accounts by Industry</h3>
    <canvas id="industryBarChart" width="600" height="300"></canvas>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        try {
          const industryData = {{ industry_counts|safe }};
          const labels = industryData.map(item => item.industry || "Unknown");
          const data = industryData.map(item => item.account_count);

          if (labels.length === 0) {
            document.getElementById('industryBarChart').outerHTML =
              "<div style='color: #888; margin: 1em 0;'>No industry data available to display chart.</div>";
          } else {
            new Chart(document.getElementById('industryBarChart').getContext('2d'), {
              type: 'bar',
              data: {
                labels: labels,
                datasets: [{
                  label: 'Accounts',
                  data: data,
                  backgroundColor: 'rgba(54, 162, 235, 0.6)'
                }]
              },
              options: {
                plugins: {
                  legend: { display: false }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Accounts' }
                  },
                  x: {
                    title: { display: true, text: 'Industry' }
                  }
                }
              }
            });
          }
        } catch (err) {
          console.error("Error rendering industry bar chart:", err);
          const chartContainer = document.getElementById('industryBarChart');
          if (chartContainer) {
            chartContainer.outerHTML = "<div style='color:red;'>Could not render chart. See console for details.</div>";
          }
        }
      });
    </script>
    <pre id="industry-debug">{{ industry_counts|safe }}</pre>

    <h3>List of Accounts</h3>
    <table class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Industry</th>
        </tr>
      </thead>
      <tbody>
        {% for account in accounts %}
          <tr>
            <td>{{ account.id }}</td>
            <td>
              <a href="{% url 'account_detail' account.id %}">{{ account.name }}</a>
            </td>
            <td>{{ account.industry }}</td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="3">No accounts found.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endblock %}

